<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Screenshot Preview</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="previewStyles.css" />
  </head>
  <body>
    <div class="preview-header">
      <div class="window-controls">
        <button id="close-window" class="window-btn close" title="Close Preview"></button>
      </div>
      <div class="title-container">
        <input type="text" class="preview-title-input" value="Screenshot Preview" placeholder="Enter screenshot name..." />
        <svg class="edit-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
        </svg>
      </div>
    </div>

    <div class="image-container">
      <img
        class="preview-image"
        id="previewImage"
        alt="Screenshot preview"
        onload="console.log('[PREVIEW] Image loaded successfully', this.naturalWidth, 'x', this.naturalHeight); document.body.style.borderColor='green';"
        onerror="console.error('[PREVIEW] Image failed to load'); document.body.style.borderColor='red'; this.style.display='none';"
      />
    </div>

    <div class="toolbar">
      <div class="share-container">
        <button class="toolbar-btn" id="share-btn" title="Share">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.935-2.186 2.25 2.25 0 0 0-3.935 2.186Z" />
          </svg>
        </button>
        <div class="share-menu" id="share-menu">
          <div class="share-menu-item" data-app="discord">
            <div class="app-icon discord-icon"></div>
            <span class="app-name">Discord</span>
          </div>
          <div class="share-menu-item" data-app="slack">
            <div class="app-icon slack-icon"></div>
            <span class="app-name">Slack</span>
          </div>
          <div class="share-menu-item" data-app="whatsapp">
            <div class="app-icon whatsapp-icon"></div>
            <span class="app-name">WhatsApp</span>
          </div>
          <div class="share-menu-item" data-app="telegram">
            <div class="app-icon telegram-icon"></div>
            <span class="app-name">Telegram</span>
          </div>
          <div class="share-menu-item" data-app="messages">
            <div class="app-icon messages-icon"></div>
            <span class="app-name">Messages</span>
          </div>
          <div class="share-menu-item" data-app="mail">
            <div class="app-icon mail-icon"></div>
            <span class="app-name">Mail</span>
          </div>
        </div>
      </div>
      <button class="toolbar-btn" title="Copy to clipboard">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" />
        </svg>
      </button>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
      <div class="toast-content">
        <svg class="toast-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>
        <span class="toast-message" id="toast-message">Image copied to clipboard</span>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require('electron');
      let renameTimer = null;
      let autoCloseTimer = null;
      
      // Auto-close functionality
      function startAutoCloseTimer() {
        console.log('[PREVIEW] Starting auto-close timer (3 seconds)...');
        if (autoCloseTimer) clearTimeout(autoCloseTimer);
        autoCloseTimer = setTimeout(() => {
          console.log('[PREVIEW] Auto-close timer firing...');
          ipcRenderer.send('preview-close');
        }, 3000); // 3 seconds
      }
      
      function stopAutoCloseTimer() {
        console.log('[PREVIEW] Stopping auto-close timer...');
        if (autoCloseTimer) {
          clearTimeout(autoCloseTimer);
          autoCloseTimer = null;
        }
      }
      
      // Toast notification function
      function showToast(message) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        
        toastMessage.textContent = message;
        toast.classList.add('show');
        
        // Auto-hide after 2 seconds
        setTimeout(() => {
          toast.classList.remove('show');
        }, 2000);
      }
      
      function debouncedRename(filename) {
        if (renameTimer) clearTimeout(renameTimer);
        renameTimer = setTimeout(() => {
          ipcRenderer.send('preview-save', filename);
        }, 500);
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        const titleInput = document.querySelector('.preview-title-input');
        if (titleInput) {
          titleInput.addEventListener('input', (e) => {
            const filename = e.target.value.trim() || 'Screenshot';
            debouncedRename(filename);
          });
        }
        
        const editIcon = document.querySelector('.edit-icon');
        if (editIcon && titleInput) {
          editIcon.addEventListener('click', () => {
            titleInput.focus();
          });
        }
        
        const closeBtn = document.getElementById('close-window');
        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            ipcRenderer.send('preview-close');
          });
        }
        
        // Share menu functionality
        const shareBtn = document.getElementById('share-btn');
        const shareMenu = document.getElementById('share-menu');
        
        if (shareBtn && shareMenu) {
          shareBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            shareMenu.classList.toggle('show');
          });
          
          // Close menu when clicking outside
          document.addEventListener('click', (e) => {
            if (!shareBtn.contains(e.target) && !shareMenu.contains(e.target)) {
              shareMenu.classList.remove('show');
            }
          });
          
          // Handle app selection
          const shareMenuItems = shareMenu.querySelectorAll('.share-menu-item');
          shareMenuItems.forEach(item => {
            item.addEventListener('click', (e) => {
              const appName = item.getAttribute('data-app');
              console.log('Selected app:', appName);
              
              // Send share request to main process
              ipcRenderer.send('preview-share', appName);
              
              // Show toast notification
              showToast('Image copied to clipboard');
              
              // Close the share menu
              shareMenu.classList.remove('show');
              
              // Close preview window after a short delay to show the toast
              setTimeout(() => {
                ipcRenderer.send('preview-close');
              }, 500);
            });
          });
        }
        
        // Clipboard copy functionality
        const copyBtn = document.querySelector('.toolbar-btn[title="Copy to clipboard"]');
        if (copyBtn) {
          copyBtn.addEventListener('click', (e) => {
            console.log('Copy to clipboard clicked');
            
            // Send copy request to main process
            ipcRenderer.send('preview-copy');
            
            // Show toast notification
            showToast('Image copied to clipboard');
          });
        }
        
        // Start auto-close timer when page loads
        startAutoCloseTimer();
        
        // Pause timer on mouse enter, resume on mouse leave
        document.body.addEventListener('mouseenter', () => {
          console.log('[PREVIEW] Mouse entered, pausing auto-close timer');
          stopAutoCloseTimer();
        });
        
        document.body.addEventListener('mouseleave', () => {
          console.log('[PREVIEW] Mouse left, resuming auto-close timer');
          startAutoCloseTimer();
        });
      });
    </script>
  </body>
</html>
